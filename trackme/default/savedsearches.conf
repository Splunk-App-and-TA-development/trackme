# savedsearches.conf

# Monitoring of data sources

[TrackMe - Data sources availability short term tracker]
cron_schedule = */5 * * * *
description = This scheduled report tracks and updates the data source availability KVstore based lookup
dispatch.earliest_time = -4h
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen where index=* sourcetype=* `trackme_tstats_main_filter` `apply_data_source_blacklists_data_retrieve` by index, sourcetype\
| eval current_data_last_lag_seen=now()-current_data_last_time_seen\
| rename index as data_index, sourcetype as data_sourcetype\
| append [ |inputlookup trackme_data_source_monitoring | eval key=_key]\
| stats first(key) as _key, first(*) as "*" by data_index, data_sourcetype\
| eval data_last_lag_seen=if(isnotnull(current_data_last_lag_seen), current_data_last_lag_seen, data_last_lag_seen)\
| eval data_last_time_seen=if(isnotnull(current_data_last_time_seen), current_data_last_time_seen, data_last_time_seen)\
| fields - current_*\
| `trackme_default_monitored_state`\
| `trackme_default_lag`\
| `trackme_default_monitored_wdays`\
| eval data_name=if(isnull(data_name), data_index . ":" . data_sourcetype, data_name)\
| eval data_monitoring_level=if(isnull(data_monitoring_level), "sourcetype", data_monitoring_level)\
| eventstats max(data_last_time_seen) as data_last_time_seen_idx, min(data_last_lag_seen) as data_last_lag_seen_idx by data_index\
| `trackme_data_sources_filtering`\
| outputlookup trackme_data_source_monitoring append=t key_field=_key\
| lookup local=t trackme_data_source_monitoring data_name OUTPUT data_name as FOUND | where isnull(FOUND) | fields - FOUND\
| outputlookup trackme_data_source_monitoring append=t\
| stats count

[TrackMe - Data sources availability long term tracker]
cron_schedule = 1 * * * *
description = This scheduled report tracks and updates the data source availability KVstore based lookup
dispatch.earliest_time = -7d
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen where index=* `trackme_tstats_main_filter` `apply_data_source_blacklists_data_retrieve` by index, sourcetype\
| eval current_data_last_lag_seen=now()-current_data_last_time_seen\
| rename index as data_index, sourcetype as data_sourcetype\
| append [ |inputlookup trackme_data_source_monitoring | eval key=_key]\
| stats first(key) as _key, first(*) as "*" by data_index, data_sourcetype\
| eval data_last_lag_seen=if(isnotnull(current_data_last_lag_seen), current_data_last_lag_seen, data_last_lag_seen)\
| eval data_last_time_seen=if(isnotnull(current_data_last_time_seen), current_data_last_time_seen, data_last_time_seen)\
| fields - current_*\
| `trackme_default_monitored_state`\
| `trackme_default_lag`\
| `trackme_default_monitored_wdays`\
| eval data_name=if(isnull(data_name), data_index . ":" . data_sourcetype, data_name)\
| eval data_monitoring_level=if(isnull(data_monitoring_level), "sourcetype", data_monitoring_level)\
| eventstats max(data_last_time_seen) as data_last_time_seen_idx, min(data_last_lag_seen) as data_last_lag_seen_idx by data_index\
| `trackme_data_sources_filtering`\
| outputlookup trackme_data_source_monitoring append=t key_field=_key\
| lookup local=t trackme_data_source_monitoring data_name OUTPUT data_name as FOUND | where isnull(FOUND) | fields - FOUND\
| outputlookup trackme_data_source_monitoring append=t\
| stats count

[TrackMe - Data sources auto mode tracker update (updates value for data_wday_monitoring)]
cron_schedule = 0 2 * * *
description = This scheduled report tracks and updates the value for auto defined data_wday_monitoring
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen where index=* `trackme_tstats_main_filter` `apply_data_source_blacklists_data_retrieve` by _time index, sourcetype span=1d\
| eval wday=strftime(_time, "%a")\
| streamstats count(eval(wday="Sat")) as saturday_seen, count(eval(wday="Sun")) as sunday_seen by index, sourcetype\
| stats max(saturday_seen) as saturday_seen, max(sunday_seen) as sunday_seen by index, sourcetype\
| eval auto_data_monitoring_wdays=case(saturday_seen>1 AND sunday_seen>1, "auto:all_days", saturday>1 AND sunday_seen<1, "auto:monday-to-saturday", saturday_seen<=1 AND sunday_seen<=1, "auto:monday-to-friday")\
| rename index as data_index, sourcetype as data_sourcetype | eval data_name = data_index . ":" . data_sourcetype\
| fields data_name, data_index, data_sourcetype, auto_data_monitoring_wdays\
| join data_name [ |inputlookup trackme_data_source_monitoring | eval key=_key]\
| eval data_monitoring_days=if(match(data_monitoring_days, "^manual:"), data_monitoring_days, auto_data_monitoring_wdays) | fields - auto_*\
| rename key as _key\
| outputlookup trackme_data_source_monitoring append=t key_field=_key\
| stats count

[TrackMe - Alert on data source availability]
alert.digest_mode = 0
alert.severity = 4
alert.suppress = 1
alert.suppress.fields = data_name, data_index, data_sourcetype
alert.suppress.period = 24h
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This alert will trigger if one or more of the data sources is seen as unavailable, with a default throttling period of 8 hours
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
display.visualizations.charting.chart = line
disabled = true
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search = | inputlookup trackme_data_source_monitoring\
| where data_monitored_state="enabled"\
| `trackme_eval_data_source_state`\
| `apply_data_source_blacklists`\
| where data_source_state="red"

# Monitoring of hosts

#
# Host monitoring
#

[TrackMe - hosts availability short term tracker]
cron_schedule = */5 * * * *
description = This scheduled report tracks and updates the data source availability KVstore based lookup
dispatch.earliest_time = -4h
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen, values(sourcetype) as sourcetype where index=* sourcetype=* `trackme_tstats_main_filter` `apply_data_host_blacklists_data_retrieve` by index, host\
| stats max(current_data_last_time_seen) as current_data_last_time_seen, values(index) as index, values(sourcetype) as sourcetype by host\
| eval current_data_last_lag_seen=now()-current_data_last_time_seen\
| rename host as data_host, index as data_index, sourcetype as data_sourcetype\
| stats max(current_data_last_time_seen) as current_data_last_time_seen, min(current_data_last_lag_seen) as current_data_last_lag_seen, values(data_index) as data_index, values(data_sourcetype) as data_sourcetype by data_host\
| append [ |inputlookup trackme_host_monitoring | eval key=_key | makemv delim="," data_index | makemv delim="," data_sourcetype ]\
| stats first(key) as key, values(data_index) as data_index, values(data_sourcetype) as data_sourcetype, first(*) as "*" by data_host\
| eval data_last_lag_seen=if(isnotnull(current_data_last_lag_seen), current_data_last_lag_seen, data_last_lag_seen)\
| eval data_last_time_seen=if(isnotnull(current_data_last_time_seen), current_data_last_time_seen, data_last_time_seen)\
| `trackme_default_host_monitored_state`\
| `trackme_default_host_lag`\
| `trackme_default_host_monitored_wdays`\
| rename key as _key\
| eval data_index=mvdedup(data_index), data_sourcetype=mvdedup(data_sourcetype)\
| eval data_index=mvjoin(data_index, ","), data_sourcetype=mvjoin(data_sourcetype, ",")\
| outputlookup trackme_host_monitoring append=t key_field=_key\
| lookup local=t trackme_host_monitoring data_host OUTPUT data_host as FOUND | where isnull(FOUND) | fields - FOUND\
| outputlookup trackme_host_monitoring append=t\
| stats count

[TrackMe - hosts availability long term tracker]
cron_schedule = 1 * * * *
description = This scheduled report tracks and updates the data source availability KVstore based lookup
dispatch.earliest_time = -7d
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen, values(sourcetype) as sourcetype where index=* sourcetype=* `trackme_tstats_main_filter` `apply_data_host_blacklists_data_retrieve` by index, host\
| stats max(current_data_last_time_seen) as current_data_last_time_seen, values(index) as index, values(sourcetype) as sourcetype by host\
| eval current_data_last_lag_seen=now()-current_data_last_time_seen\
| rename host as data_host, index as data_index, sourcetype as data_sourcetype\
| stats max(current_data_last_time_seen) as current_data_last_time_seen, min(current_data_last_lag_seen) as current_data_last_lag_seen, values(data_index) as data_index, values(data_sourcetype) as data_sourcetype by data_host\
| append [ |inputlookup trackme_host_monitoring | eval key=_key | makemv delim="," data_index | makemv delim="," data_sourcetype ]\
| stats first(key) as key, values(data_index) as data_index, values(data_sourcetype) as data_sourcetype, first(*) as "*" by data_host\
| eval data_last_lag_seen=if(isnotnull(current_data_last_lag_seen), current_data_last_lag_seen, data_last_lag_seen)\
| eval data_last_time_seen=if(isnotnull(current_data_last_time_seen), current_data_last_time_seen, data_last_time_seen)\
| `trackme_default_host_monitored_state`\
| `trackme_default_host_lag`\
| `trackme_default_host_monitored_wdays`\
| rename key as _key\
| eval data_index=mvdedup(data_index), data_sourcetype=mvdedup(data_sourcetype)\
| eval data_index=mvjoin(data_index, ","), data_sourcetype=mvjoin(data_sourcetype, ",")\
| outputlookup trackme_host_monitoring append=t key_field=_key\
| lookup local=t trackme_host_monitoring data_host OUTPUT data_host as FOUND | where isnull(FOUND) | fields - FOUND\
| outputlookup trackme_host_monitoring append=t\
| stats count

[TrackMe - Data hosts auto mode tracker update (updates value for data_wday_monitoring)]
cron_schedule = 0 3 * * *
description = This scheduled report tracks and updates the value for auto defined data_wday_monitoring
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
enableSched = 1
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search  = | tstats max(_time) as current_data_last_time_seen where index=* `trackme_tstats_main_filter` `apply_data_host_blacklists_data_retrieve` by _time host span=1d\
| eval wday=strftime(_time, "%a")\
| streamstats count(eval(wday="Sat")) as saturday_seen, count(eval(wday="Sun")) as sunday_seen by host\
| stats max(saturday_seen) as saturday_seen, max(sunday_seen) as sunday_seen by host\
| eval auto_data_monitoring_wdays=case(saturday_seen>1 AND sunday_seen>1, "auto:all_days", saturday>1 AND sunday_seen<1, "auto:monday-to-saturday", saturday_seen<=1 AND sunday_seen<=1, "auto:monday-to-friday")\
| rename host as data_host\
| fields data_host, auto_data_monitoring_wdays\
| join data_host [ |inputlookup trackme_host_monitoring | eval key=_key]\
| eval data_monitoring_days=if(match(data_monitoring_days, "^manual:"), data_monitoring_days, auto_data_monitoring_wdays) | fields - auto_*\
| rename key as _key\
| outputlookup trackme_host_monitoring append=t key_field=_key\
| stats count

[TrackMe - Alert on data host availability]
alert.digest_mode = 0
alert.severity = 4
alert.suppress = 1
alert.suppress.fields = data_host
alert.suppress.period = 24h
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This alert will trigger if one or more of the data hosts is seen as unavailable, with a default throttling period of 8 hours
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
display.visualizations.charting.chart = line
disabled = true
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = trackme
request.ui_dispatch_view = trackme
search = | inputlookup trackme_host_monitoring\
| where data_monitored_state="enabled"\
| `trackme_eval_data_host_state`\
| `apply_data_host_blacklists`\
| where data_host_state="red"
